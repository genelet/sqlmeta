syntax = "proto3";
package sqlmeta;

option go_package = "github.com/genelet/sqlmeta/xmeta";

message ObjectName {
    repeated string Idents = 1;
}

message BigInt {
    bool IsUnsigned = 1;
}

message SmallInt {
    bool IsUnsigned = 1;
}

message Int {
    bool IsUnsigned = 1;
}

message TinyInt {
    bool IsUnsigned = 1;
}

message MediumInt {
    bool IsUnsigned = 1;
}

message Real {
    bool IsUnsigned = 1;
}

message Float {
    uint32 Size = 1;
    bool IsUnsigned = 2;
}

message Decimal {
    uint32 Precision = 1;
    uint32 Scale = 2;
    bool IsUnsigned = 3;
}

message CharType {
    uint32 Size = 1;
}

message VarcharType {
    uint32 Size = 1;
}

message Timestamp {
    bool WithTimeZone = 1;
}

enum DataTypeSingle {
    DataTypeSingleUnknown = 0;
    Double = 1;
    Boolean = 2;
    Time = 3;
    Date = 4;
    Bytea = 5;
    Text = 6;
    Regclass = 7;
    UUID = 8;
    Year = 9;
}

message BitType {
    uint32 Size = 1;
    bool Varying = 2;
}

message DoubleType {
    bool is_double_precision = 1;
}

message CollateType {
    DataType Type = 1;
    string CollationName = 2;
}

// Simple MetaColumnDef (name + type only) moved to enhanced version below
// StructData now uses the enhanced MetaColumnDef with DefaultValue and Constraints

message StructData {
    repeated ColumnDef Fields = 1;
}

message ArrayData {
    DataType Type = 1;
}

// MySQL ENUM type
message EnumType {
    repeated string Values = 1;
}

// MySQL SET type
message SetType {
    repeated string Values = 1;
}

// Foreign Key referential actions (shared across dialects)
enum ReferentialAction {
    ReferentialAction_Unknown = 0;
    ReferentialAction_NoAction = 1;
    ReferentialAction_Restrict = 2;
    ReferentialAction_Cascade = 3;
    ReferentialAction_SetNull = 4;
    ReferentialAction_SetDefault = 5;
}

// Foreign Key match options (shared across dialects)
enum MatchOption {
    MatchOption_Unknown = 0;
    MatchOption_Simple = 1;
    MatchOption_Partial = 2;
    MatchOption_Full = 3;
}

// =============================================================================
// COLUMN AND TABLE CONSTRAINT TYPES
// =============================================================================

// Null value indicator (for SQL expression tracking)
enum NullValue {
    NullValueUnknown = 0;
    NullValueConfirm = 1;
}

// Auto-increment indicator (MySQL AUTO_INCREMENT, etc.)
enum AutoIncrement {
    AutoIncrementUnknown = 0;
    AutoIncrementConfirm = 1;
}

// NOT NULL constraint indicator
enum NotNullColumnSpec {
    NotNullColumnSpecUnknown = 0;
    NotNullColumnSpecConfirm = 1;
}

// Primary Key / Unique constraint for a column
message UniqueColumnSpec {
    bool IsPrimaryKey = 1;
}

// Foreign key column reference expression
message ReferenceKeyExpr {
    string TableName = 1;
    repeated string Columns = 2;
}

// Column-level REFERENCES constraint (FOREIGN KEY)
message ReferencesColumnSpec {
    ObjectName TableName = 1;
    repeated string Columns = 2;
    ReferentialAction OnDelete = 3;
    ReferentialAction OnUpdate = 4;
    MatchOption Match = 5;
    bool Deferrable = 6;
    bool InitiallyDeferred = 7;
}

// Table-level UNIQUE/PRIMARY KEY constraint
message UniqueTableConstraint {
    bool IsPrimary = 1;
    repeated string Columns = 2;
    string IndexName = 3;
    bool IsJustIndex = 4;
}

// Table-level FOREIGN KEY constraint
message ReferentialTableConstraint {
    repeated string Columns = 1;
    ReferenceKeyExpr KeyExpr = 2;
    ReferentialAction OnDelete = 3;
    ReferentialAction OnUpdate = 4;
    MatchOption Match = 5;
    bool Deferrable = 6;
    bool InitiallyDeferred = 7;
}

message DataType {
    oneof TypeClause {
        Int IntData = 1;
        SmallInt SmallIntData = 2;
        BigInt BigIntData = 3;
        Decimal DecimalData = 4;
        CharType CharData = 8;
        VarcharType VarcharData = 9;
        ObjectName CustomData = 10;
        ArrayData ArrayData = 11;
        StructData StructData = 12;
        DataTypeSingle UUIDData = 14;
        Timestamp TimestampData = 15;
        DataTypeSingle BooleanData = 13;
        DataTypeSingle DateData = 16;
        DataTypeSingle TimeData = 17;
        DoubleType DoubleData = 18;
        Float FloatData = 19;
        Real RealData = 20;
        DataTypeSingle TextData = 21;
        BitType BitData = 22;
        DataTypeSingle RegclassData = 23;
        DataTypeSingle ByteaData = 24;
        CollateType CollateData = 25;
        EnumType EnumData = 26;
        SetType SetData = 27;
        TinyInt TinyIntData = 28;
        MediumInt MediumIntData = 29;
        DataTypeSingle YearData = 30;
    }
}

// =============================================================================
// COLUMN AND TABLE DEFINITIONS (Unified)
// =============================================================================

import "google/protobuf/any.proto";

message ColumnConstraintSpec {
    oneof ColumnConstraintSpecClause {
        UniqueColumnSpec UniqueItem = 1;
        google.protobuf.Any CheckItem = 2;
        ReferencesColumnSpec ReferenceItem = 3;
        NotNullColumnSpec NotNullItem = 4;
    }
}

message ColumnConstraint {
    string Name = 1;
    ColumnConstraintSpec Spec = 2;
    bool NotEnforced = 3;
}

message ColumnDef {
    string Name = 1;
    DataType DataType = 2;
    google.protobuf.Any Default = 3;
    repeated AutoIncrement MyDecos = 4;
    repeated ColumnConstraint Constraints = 5;
    string Comment = 6;
    map<string, string> Options = 7;
}

message MetaTable {
    ObjectName Name = 1;
    string Type = 2; // BASE TABLE, VIEW, etc.
    repeated TableElement Elements = 3;
    string Comment = 4;
    map<string, string> Options = 5;
}

message MetaView {
    ObjectName Name = 1;
    string Definition = 2;
    string Comment = 3;
    map<string, string> Options = 4;
}

message MetaSequence {
    ObjectName Name = 1;
    string Comment = 2;
    map<string, string> Options = 3;
}

message MetaDatabase {
    string Name = 1;
    repeated MetaTable Tables = 2;
    repeated MetaView Views = 3;
    repeated MetaSequence Sequences = 4;
    map<string, string> Options = 5;
}

message TableConstraintSpec {
    oneof TableConstraintSpecClause {
        ReferentialTableConstraint ReferenceItem = 1;
        google.protobuf.Any CheckItem = 2;
        UniqueTableConstraint UniqueItem = 3;
    }
}

message TableConstraint {
    string Name = 1;
    TableConstraintSpec Spec = 2;
    bool NotEnforced = 3;
}

message TableElement {
    oneof TableElementClause {
        ColumnDef ColumnDefElement = 1;
        TableConstraint TableConstraintElement = 2;
    }
}

// StructData uses the unified ColumnDef
// Note: StructData was defined at line 87, ensuring backward compatibility or update.
// If StructData at line 87 used MetaColumnDef, we should update usage.
// Since we are removing MetaColumnDef, we should rely on ColumnDef.
