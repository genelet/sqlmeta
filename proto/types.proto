syntax = "proto3";
package sqlmeta;

option go_package = "github.com/genelet/sqlmeta/xmeta";

message ObjectName {
    repeated string Idents = 1;
}

message BigInt {
    bool IsUnsigned = 1;
}

message SmallInt {
    bool IsUnsigned = 1;
}

message Int {
    bool IsUnsigned = 1;
}

message TinyInt {
    bool IsUnsigned = 1;
}

message MediumInt {
    bool IsUnsigned = 1;
}

message Real {
    bool IsUnsigned = 1;
}

message Float {
    uint32 Size = 1;
    bool IsUnsigned = 2;
}

message Decimal {
    uint32 Precision = 1;
    uint32 Scale = 2;
    bool IsUnsigned = 3;
}

message CharType {
    uint32 Size = 1;
}

message VarcharType {
    uint32 Size = 1;
}

message Timestamp {
    bool WithTimeZone = 1;
}

enum DataTypeSingle {
    DataTypeSingleUnknown = 0;
    Double = 1;
    Boolean = 2;
    Time = 3;
    Date = 4;
    Bytea = 5;
    Text = 6;
    Regclass = 7;
    UUID = 8;
    Year = 9;
}

message BitType {
    uint32 Size = 1;
    bool Varying = 2;
}

message DoubleType {
    bool is_double_precision = 1;
}

message CollateType {
    DataType Type = 1;
    string CollationName = 2;
}

// Simple MetaColumnDef (name + type only) moved to enhanced version below
// StructData now uses the enhanced MetaColumnDef with DefaultValue and Constraints

message StructData {
    repeated MetaColumnDef Fields = 1;
}

message ArrayData {
    DataType Type = 1;
}

// MySQL ENUM type
message EnumType {
    repeated string Values = 1;
}

// MySQL SET type
message SetType {
    repeated string Values = 1;
}

// Foreign Key referential actions (shared across dialects)
enum ReferentialAction {
    ReferentialAction_Unknown = 0;
    ReferentialAction_NoAction = 1;
    ReferentialAction_Restrict = 2;
    ReferentialAction_Cascade = 3;
    ReferentialAction_SetNull = 4;
    ReferentialAction_SetDefault = 5;
}

// Foreign Key match options (shared across dialects)
enum MatchOption {
    MatchOption_Unknown = 0;
    MatchOption_Simple = 1;
    MatchOption_Partial = 2;
    MatchOption_Full = 3;
}

// =============================================================================
// COLUMN AND TABLE CONSTRAINT TYPES
// =============================================================================

// Null value indicator (for SQL expression tracking)
enum NullValue {
    NullValueUnknown = 0;
    NullValueConfirm = 1;
}

// Auto-increment indicator (MySQL AUTO_INCREMENT, etc.)
enum AutoIncrement {
    AutoIncrementUnknown = 0;
    AutoIncrementConfirm = 1;
}

// NOT NULL constraint indicator
enum NotNullColumnSpec {
    NotNullColumnSpecUnknown = 0;
    NotNullColumnSpecConfirm = 1;
}

// Primary Key / Unique constraint for a column
message UniqueColumnSpec {
    bool IsPrimaryKey = 1;
}

// Foreign key column reference expression
message ReferenceKeyExpr {
    string TableName = 1;
    repeated string Columns = 2;
}

// Column-level REFERENCES constraint (FOREIGN KEY)
message ReferencesColumnSpec {
    ObjectName TableName = 1;
    repeated string Columns = 2;
    ReferentialAction OnDelete = 3;
    ReferentialAction OnUpdate = 4;
    MatchOption Match = 5;
    bool Deferrable = 6;
    bool InitiallyDeferred = 7;
}

// Table-level UNIQUE/PRIMARY KEY constraint
message UniqueTableConstraint {
    bool IsPrimary = 1;
    repeated string Columns = 2;
    string IndexName = 3;
    bool IsJustIndex = 4;
}

// Table-level FOREIGN KEY constraint
message ReferentialTableConstraint {
    repeated string Columns = 1;
    ReferenceKeyExpr KeyExpr = 2;
    ReferentialAction OnDelete = 3;
    ReferentialAction OnUpdate = 4;
    MatchOption Match = 5;
    bool Deferrable = 6;
    bool InitiallyDeferred = 7;
}

message DataType {
    oneof TypeClause {
        Int IntData = 1;
        SmallInt SmallIntData = 2;
        BigInt BigIntData = 3;
        Decimal DecimalData = 4;
        CharType CharData = 8;
        VarcharType VarcharData = 9;
        ObjectName CustomData = 10;
        ArrayData ArrayData = 11;
        StructData StructData = 12;
        DataTypeSingle UUIDData = 14;
        Timestamp TimestampData = 15;
        DataTypeSingle BooleanData = 13;
        DataTypeSingle DateData = 16;
        DataTypeSingle TimeData = 17;
        DoubleType DoubleData = 18;
        Float FloatData = 19;
        Real RealData = 20;
        DataTypeSingle TextData = 21;
        BitType BitData = 22;
        DataTypeSingle RegclassData = 23;
        DataTypeSingle ByteaData = 24;
        CollateType CollateData = 25;
        EnumType EnumData = 26;
        SetType SetData = 27;
        TinyInt TinyIntData = 28;
        MediumInt MediumIntData = 29;
        DataTypeSingle YearData = 30;
    }
}

// =============================================================================
// META COLUMN AND TABLE DEFINITIONS
// String-based versions for schema metadata storage (no SQL expression types)
// =============================================================================

// Metadata-only column constraint (with string-based CHECK expression)
message MetaColumnConstraintSpec {
    oneof MetaColumnConstraintSpecClause {
        UniqueColumnSpec UniqueItem = 1;
        string CheckExpression = 2;           // e.g., "amount > 0"
        ReferencesColumnSpec ReferenceItem = 3;
        NotNullColumnSpec NotNullItem = 4;
    }
}

// Metadata-only column constraint wrapper
message MetaColumnConstraint {
    string Name = 1;
    MetaColumnConstraintSpec Spec = 2;
    bool NotEnforced = 3;
}

// Metadata-only column definition (with string-based DEFAULT value)
message MetaColumnDef {
    string Name = 1;
    DataType DataType = 2;
    string DefaultValue = 3;                  // e.g., "CURRENT_TIMESTAMP", "0"
    repeated AutoIncrement MyDecos = 4;
    repeated MetaColumnConstraint Constraints = 5;
}

// Metadata-only table constraint (with string-based CHECK expression)
message MetaTableConstraintSpec {
    oneof MetaTableConstraintSpecClause {
        ReferentialTableConstraint ReferenceItem = 1;
        string CheckExpression = 2;           // e.g., "amount > 0"
        UniqueTableConstraint UniqueItem = 3;
    }
}

// Metadata-only table constraint wrapper
message MetaTableConstraint {
    string Name = 1;
    MetaTableConstraintSpec Spec = 2;
    bool NotEnforced = 3;
}

// Metadata-only table element (column or constraint)
message MetaTableElement {
    oneof MetaTableElementClause {
        MetaColumnDef ColumnDefElement = 1;
        MetaTableConstraint TableConstraintElement = 2;
    }
}

// Metadata-only struct type (uses MetaColumnDef for fields)
message MetaStructData {
    repeated MetaColumnDef Fields = 1;
}
